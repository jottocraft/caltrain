<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="shortcut icon" href="train.png" type="image/png">

  <!--Import Google Icon Font-->
       <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Extended" rel="stylesheet">
       <link type="text/css" rel="stylesheet" href="fluid.css"  media="screen,projection"/>
       <link type="text/css" rel="stylesheet" href="https://storage.googleapis.com/non-spec-apps/mio-icons/latest/outline.css"  media="screen,projection"/>
       <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet">
  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

  <!--OpenGraph -->
  <meta property="og:url" content="https://fluid.js.org" />
  <meta property="og:title" content="TRAIN" />
  <meta property="og:description" content="TAKE THE TRAIN" />
  <meta property="og:image" content="https://fluid.js.org/icon.png" />

  <meta charset="utf-8">
  <title>CalTrain Corridor</title>
<meta name="description" content="">
  <meta name="author" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">


</head>

<body class="dark">


  <script src="https://cdn.rawgit.com/showdownjs/showdown/1.8.6/dist/showdown.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script type="text/javascript" src="fluid.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.1.0/firebase.js"></script>
  <script src="moment.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.4.0/firebase.js"></script>

  <script>
  var stations = {};
var train = {};
var trains = [];
var alerts = [];
  function call(cb) {
    var loaded = 0;
    function load() {
      loaded++;
      if (loaded == 2) {
        console.log(stations)
        if (cb) cb();
		$(".fetch").html("Last updated " + new Date().toLocaleTimeString())
       }
    }
    if (true) {
      console.log("Fetching data")
    $.getJSON("https://api.511.org/transit/VehicleMonitoring?api_key=05c0e41a-ff3a-46fc-a69c-2f974ef45741&agency=CT&format=JSON", function(data) {
      trains = data.Siri.ServiceDelivery.VehicleMonitoringDelivery.VehicleActivity;
      for (var i = 0; i < trains.length; i++) {
        train[trains[i].MonitoredVehicleJourney.VehicleRef] = trains[i]
      }
      console.log(train)
      load();
    })
	$.getJSON("http://api.511.org/transit/servicealerts?api_key=05c0e41a-ff3a-46fc-a69c-2f974ef45741&format=json&agency=CT", function(data) {
	alerts = [];
	for (var i = 0; i < data["_entity"].length; i++) {
	if (data["_entity"][i]["_alert"]["_informed_entity"][0]["_agency_id"] == "CT") {
	alerts.push(data["_entity"][i]["_alert"]);
	}
	}
	load();
	console.log(alerts);
    })
  } else {
    //GET TCOH DATA ONCE (WITHOUT REALTIME)
firebase.database().ref('trains').once('value').then(function(datasnapshot) {
  train = datasnapshot.val()
  if (cb) cb();
  $(".fetch").html("Last updated " + new Date().toLocaleTimeString())
});
  }
  }
function pixels(num, tN) {
lastPx[tN] = num;
var master = 1500 / 23;
var offset = 20;
return (master * num) + (offset * (num - 1));
}
var lastPx = {};
function stationOffset(station, tN) {
if (station.includes("San Fransisco") && !station.includes("So")) var px = pixels(1, tN);
if (station.includes("22")) var px = pixels(2, tN);
if (station.includes("Bayshore")) var px = pixels(3, tN);
if (station.includes("San Fransisco") && station.includes("So")) var px = pixels(4, tN);
if (station.includes("San Bruno")) var px = pixels(5, tN);
if (station.includes("Millbrae")) var px = pixels(6, tN);
if (station.includes("Burlingame")) var px = pixels(7, tN);
if (station.includes("San Mateo")) var px = pixels(8, tN);
if (station.includes("Hayward Park")) var px = pixels(9, tN);
if (station.includes("Hillsdale")) var px = pixels(10, tN);
if (station.includes("Belmont")) var px = pixels(11, tN);
if (station.includes("San Carlos")) var px = pixels(12, tN);
if (station.includes("Redwood City")) var px = pixels(13, tN);
if (station.includes("Menlo Park")) var px = pixels(14, tN);
if (station.includes("Palo Alto")) var px = pixels(15, tN);
if (station.includes("California Ave")) var px = pixels(16, tN);
if (station.includes("San Antonio")) var px = pixels(17, tN);
if (station.includes("Mountain View")) var px = pixels(18, tN);
if (station.includes("Sunnyvale")) var px = pixels(19, tN);
if (station.includes("Lawrence")) var px = pixels(20, tN);
if (station.includes("Santa Clara")) var px = pixels(21, tN);
if (station.includes("College Park")) var px = pixels(22, tN);
if (station.includes("Diridon")) var px = pixels(23, tN);
return px;
}
function between(tN, dep, arr, dir, p) {
//station and percentage
var next = stationOffset(arr, tN);
if (dep !== null) {
var prev = stationOffset(dep);
} else {
if (dir == "SB") var prev = pixels(lastPx[tN] - 1);
if (dir == "NB") var prev = pixels(lastPx[tN] + 1);
}

return ((next - prev) * p ) + prev;
}
var stats = new Object;
function render(tN, u) {
//train object
var t = train[tN]
var nextArr = 0;
var bestMatch = new Date()
bestMatch.setYear(3000);
for (var i = 0; i < t.MonitoredVehicleJourney.OnwardCall.OnwardCall.length; i++) {
if ((new Date(t.MonitoredVehicleJourney.OnwardCall.OnwardCall[i].ExpectedArrivalTime).getTime() < bestMatch.getTime()) && (new Date(t.MonitoredVehicleJourney.OnwardCall.OnwardCall[i].ExpectedArrivalTime).getTime() > new Date().getTime())) {
bestMatch = new Date(t.MonitoredVehicleJourney.OnwardCall.OnwardCall[i].ExpectedArrivalTime);
nextArr = i;
}
}
var nextDep = nextArr - 1;

if (t.MonitoredVehicleJourney.DirectionRef.includes("NB")) var dir = "NB"
if (t.MonitoredVehicleJourney.DirectionRef.includes("SB")) var dir = "SB"


var arr = new Date(t.MonitoredVehicleJourney.OnwardCall.OnwardCall[nextArr].ExpectedArrivalTime);
if (nextDep < 0) {
var depS = null;
if (t.dep) {
var dep = t.dep;
} else {
t.dep = new Date();
var dep = t.dep;
}
} else {
var depS = t.MonitoredVehicleJourney.OnwardCall.OnwardCall[nextDep].StopPointName;
var dep = new Date(t.MonitoredVehicleJourney.OnwardCall.OnwardCall[nextDep].ExpectedArrivalTime);
}
var progress = ((new Date().getTime() - dep.getTime()) / (arr.getTime() - dep.getTime()));
console.log("[" + dir + " " + t.MonitoredVehicleJourney.LineRef + " " + t.MonitoredVehicleJourney.VehicleRef + "] " + depS + " -> " + t.MonitoredVehicleJourney.OnwardCall.OnwardCall[nextArr].StopPointName + " (L" + nextArr + " at N-" + (new Date().getTime() - dep.getTime()) + " for " + (arr.getTime() - dep.getTime()) + "ms " + (progress * 100) + "%)", {t: t})
var px = between(t.MonitoredVehicleJourney.VehicleRef, depS, t.MonitoredVehicleJourney.OnwardCall.OnwardCall[nextArr].StopPointName, dir, progress)
stats[Number(t.MonitoredVehicleJourney.VehicleRef)] = "Info & Leg\n[" + dir + " " + t.MonitoredVehicleJourney.LineRef + " " + t.MonitoredVehicleJourney.VehicleRef + "]" + " " +  depS + " -> " + t.MonitoredVehicleJourney.OnwardCall.OnwardCall[nextArr].StopPointName + "\n\nPath\n" + t.path

if (!u) $( ".trip." + dir + " .track").append( '<span onclick="window.alert(stats[' + t.MonitoredVehicleJourney.VehicleRef + '])" class="train ' + t.MonitoredVehicleJourney.LineRef.toLowerCase() + " " + t.MonitoredVehicleJourney.VehicleRef + '"><i class="material-icons">train</i></span>' );
$("." + t.MonitoredVehicleJourney.VehicleRef).css("margin-top", px);
if (px) { $("." + t.MonitoredVehicleJourney.VehicleRef).show(); } else { $("." + t.MonitoredVehicleJourney.VehicleRef).hide(); }
if (!u) setInterval(function() { render(tN, true);}, 2000)
}

function renderAlerts() {
for (var i = 0; i < alerts.length; i++) {
$(".alerts").append(`
<div style="display:inline-block; width: 100%;" class="section header">
  <i class="material-icons warning">warning</i>
  <h5>` + alerts[i]._header_text._translation[0]._text + `</h5>
  <p>
  ` + alerts[i]._description_text._translation[0]._text + `
  </p>
  </div>
`);
}
}

call(function() {
renderAlerts();
for (var i = 0; i < trains.length; i++) {
render(trains[i].MonitoredVehicleJourney.VehicleRef);
trains[i].path = "";
for (var ii = 0; ii < trains[i].MonitoredVehicleJourney.OnwardCall.OnwardCall.length; ii++) {
if (trains[i].MonitoredVehicleJourney.OnwardCall.OnwardCall[ii] !== undefined) trains[i].path = trains[i].path +  trains[i].MonitoredVehicleJourney.OnwardCall.OnwardCall[ii].StopPointName + ", ";
}
}
//
});

  </script>
<style>
.trip .arr {
  float: right;
}
.trip .dep {
  float: left;
}
.trip .train {
  background-color: blue;
  color: blue;
  transition: all 0.5s;
  user-select: none;
  position: absolute;
  cursor: pointer;
}
.trip .train.boarding, .trip .train.boarding i {
  color: green !important;
  background-color: transparent !important;
}
.trip .train.limited, .trip .train.limited i {
  color: #ffe0b2 !important;
  background-color: transparent !important;
}
.trip .train.local, .trip .train.local i {
  color: #9e9e9e !important;
  background-color: transparent !important;
}
.trip .train.bullet, .trip .train.bullet i {
  color: #d32f2f !important;
  background-color: transparent !important;
}
.trip .track {
  display:inline-block;
  background-color: #272727;
  height: 100%;
  width: 24px;
  border-radius: 10px;
  margin-bottom: 100px;
}
.trip .train.local i, .trip .train.limited i {
color: black;
vertical-align: middle;
}
.trip .train.bullet i, .trip .train.giants i {
color: white;
vertical-align: middle;
}
.trip {
display: inline-block;
margin-right: 50px;
height: 2000px;
float: right;
}
.labels {
float: right;
margin-right: 50px;
}
.labels div {
margin-top: calc(1500px / 23);
}
.section h4.local {
background-color: #9e9e9e !important;
  color: black !important;
  padding: 5px;
  border-radius: 10px;
}
.alerts {
display: inline-block;
width: calc(100% - 400px);
}
.section p {
margin-top: 10px;
}
.section.header {
white-space: normal !important;
}
.section.header h5 {
white-space: nowrap !important;
margin-left: 50px;
width: calc(100% - 50px);
overflow: hidden;
margin-top: -50px;
text-overflow: ellipsis;
margin-bottom: 0;
}
.section.header i {
font-size: 32px;
}
.section.header i.warning {
  color: #b3b357;
}
iframe  {
border-radius: 10px;
}
.section.header {
padding: 20px !important;
}
</style>

<div class="container" style="margin-top: 100px;">

  <div class="trip NB">


  <div class="track">

</div>

  </div>

  <div class="trip SB">


  <div class="track">
</div>

  </div>

<div class="labels">
  <div>San Fransisco</div>
  <div>22nd Street</div>
  <div>Bayshore</div>
  <div>South San Fransisco</div>
  <div>San Bruno</div>
  <div>Millbrae</div>
  <div>Burlingame</div>
  <div>San Mateo</div>
  <div>Hayward Park</div>
  <div>Hillsdale</div>
  <div>Belmont</div>
  <div>San Carlos</div>
  <div>Redwood City</div>
  <div>Menlo Park</div>
  <div>Palo Alto</div>
  <div>California Ave</div>
  <div>San Antonio</div>
  <div>Mountain View</div>
  <div>Sunnyvale</div>
  <div>Lawrence</div>
  <div>Santa Clara</div>
  <div>College Park</div>
  <div>San Jose Dirion</div>
  </div>


<img src="cal.png" style="height: 100px" />
<br /><br />
<h5 style="display: inline-block;" class="fetch">Loading...</h5>
<button onclick="call()" class="btn" style="position: absolute; right: 0; top: 0; margin: 25px;">Refresh</button>
<br />
<iframe src="https://tunein.com/embed/player/s39064/" style="height: 100px; width: 400px;padding: none; border: none;"></iframe>
<br /><br />
<div class="alerts">
</div>



</div>
</body>
</html>
